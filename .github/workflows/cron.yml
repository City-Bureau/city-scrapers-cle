name: Cron

on:
  schedule:
    - cron: "7 10-23/12 * * *"
  workflow_dispatch:

env:
  CI: true
  PIPENV_VENV_IN_PROJECT: true
  SCRAPY_SETTINGS_MODULE: city_scrapers.settings.prod
  AUTOTHROTTLE_MAX_DELAY: 30.0
  AUTOTHROTTLE_START_DELAY: 1.5
  AUTOTHROTTLE_TARGET_CONCURRENCY: 3.0
  AZURE_ACCOUNT_KEY: ${{ secrets.AZURE_ACCOUNT_KEY }}
  AZURE_ACCOUNT_NAME: ${{ secrets.AZURE_ACCOUNT_NAME }}
  AZURE_CONTAINER: ${{ secrets.AZURE_CONTAINER }}
  AZURE_STATUS_CONTAINER: ${{ secrets.AZURE_STATUS_CONTAINER }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
  OPENVPN_USER: ${{ secrets.OPENVPN_USER }}
  OPENVPN_PASS: ${{ secrets.OPENVPN_PASS }}
  OPENVPN_CONFIG: ${{ secrets.OPENVPN_CONFIG }}

jobs:
  # Temporarily commented out for testing crawl_v2 and merge script independently
  # Uncomment after merge script is verified to work correctly
  # crawl:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v1
  #
  #     - name: Connect to OpenVPN
  #       run: |
  #         sudo apt-get install -y openvpn
  #         echo "$OPENVPN_USER" | sudo tee -a /etc/openvpn/client/auth
  #         echo "$OPENVPN_PASS" | sudo tee -a /etc/openvpn/client/auth
  #         echo "$OPENVPN_CONFIG" | sudo tee -a /etc/openvpn/ovpn.conf
  #         sudo openvpn --config /etc/openvpn/ovpn.conf --daemon
  #         sleep 120
  #
  #     - name: Set up Python 3.12
  #       uses: actions/setup-python@v1
  #       with:
  #         python-version: 3.12
  #
  #     - name: Install Pipenv
  #       uses: dschep/install-pipenv-action@v1
  #
  #     - name: Cache Python dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: .venv
  #         key: pip-3.12-${{ hashFiles('**/Pipfile.lock') }}
  #         restore-keys: |
  #           pip-3.12-
  #           pip-
  #
  #     - name: Check and conditionally remove invalid virtual environment
  #       run: |
  #         if [ -d ".venv" ] && [ ! -f ".venv/bin/python" ]; then
  #           echo "Virtual environment exists but Python executable is missing. Rebuilding."
  #           rm -rf .venv
  #         elif [ ! -d ".venv" ]; then
  #           echo "No virtual environment found. Will build new one."
  #         else
  #           echo "Virtual environment appears valid. Reusing."
  #         fi
  #
  #     - name: Install dependencies
  #       run: pipenv sync
  #       env:
  #         PIPENV_DEFAULT_PYTHON_VERSION: 3.12
  #
  #     - name: Set up playwright
  #       run: |
  #         pipenv run playwright install firefox
  #
  #     - name: Run scrapers
  #       run: |
  #         export PYTHONPATH=$(pwd):$PYTHONPATH
  #         ./.deploy.sh
  #
  #     - name: Combine output feeds
  #       run: |
  #         export PYTHONPATH=$(pwd):$PYTHONPATH
  #         pipenv run scrapy combinefeeds -s LOG_ENABLED=True
  #
  #     - name: Notify slack on job failure
  #       id: slack
  #       uses: slackapi/slack-github-action@v1.17.0
  #       with:
  #         channel-id: 'C01A6HC2FU6'
  #         slack-message: 'Cronjob Failed'
  #       env:
  #         SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
  #       if: ${{ failure() }}

  crawl_v2:
    # needs: [crawl]  # Commented out for testing - re-enable after verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install Pipenv
        run: |
          python -m pip install --upgrade pip
          pip install pipenv

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: v2-3.12-${{ hashFiles('**/Pipfile.lock') }}
          restore-keys: |
            v2-3.12-
            v2-pip-

      - name: Check and conditionally remove invalid virtual environment
        run: |
          if [ -d ".venv" ] && [ ! -f ".venv/bin/python" ]; then
            echo "Virtual environment exists but Python executable is missing. Rebuilding."
            rm -rf .venv
          elif [ ! -d ".venv" ]; then
            echo "No virtual environment found. Will build new one."
          else
            echo "Virtual environment appears valid. Reusing."
          fi

      - name: Install dependencies
        run: pipenv sync
        env:
          PIPENV_DEFAULT_PYTHON_VERSION: 3.12

      - name: Install Playwright browsers
        run: pipenv run playwright install chromium

      - name: Run v2 scrapers
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          ./.deploy-harambe.sh

      - name: Verify v2 scraper output in Azure
        run: |
          pip install azure-storage-blob --quiet

          python -c "
          from azure.storage.blob import BlobServiceClient
          from datetime import datetime
          import os
          import sys

          account_name = os.getenv('AZURE_ACCOUNT_NAME')
          account_key = os.getenv('AZURE_ACCOUNT_KEY')
          container = os.getenv('AZURE_CONTAINER')

          conn_str = f'DefaultEndpointsProtocol=https;AccountName={account_name};AccountKey={account_key};EndpointSuffix=core.windows.net'
          blob_service = BlobServiceClient.from_connection_string(conn_str)
          container_client = blob_service.get_container_client(container)

          now = datetime.now()
          prefix = f'{now.year}/{now.month:02d}/{now.day:02d}/'

          blobs = list(container_client.list_blobs(name_starts_with=prefix))
          v2_blobs = [b for b in blobs if any(x in b.name for x in ['cle_planning_commission_v2', 'cle_building_standards_v2', 'cuya_arts_culture_v2'])]

          if v2_blobs:
              total_size = sum(b.size for b in v2_blobs)
              print(f'✅ Azure upload successful: {len(v2_blobs)} v2 scraper blob(s), {total_size:,} bytes total')
              for blob in v2_blobs:
                  print(f'  - {blob.name} ({blob.size:,} bytes)')
          else:
              print(f'❌ Azure upload failed: No v2 scraper blobs found for {prefix}')
              sys.exit(1)  # Fail the job to alert about upload issues
          "

      - name: Merge conventional and Harambe outputs
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          pipenv run python scripts/merge_harambe_to_latest.py
